---
title: "A Running Example"
date: "`r format(Sys.Date())`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{A Running Example}
  %\VignetteEncoding{UTF-8}
---
 
In this document, we present a full analysis of the use of the package *Rsero*, taking as an example a serological survey of chikungunya in Vietnam. Data were obtained in Quan et al., Evidence of Previous but Not Current Transmission of Chikungunya Virus in Southern and Central Vietnam: Results from a Systematic Review and a Seroprevalence Study in Four Locations, Plos NTD, 2018.
  
## Setup
  
 To install the package, type
```{r install, warning=FALSE, message = FALSE, eval=FALSE}
  devtools::install_github("nathoze/Rsero")
```

This step requires that the package devtools is installed. Installation may take a few minutes due to the compilation of the stan files that encode the serocatalytic models.

MCMC simulations are done using the package rstan, that requires Rtools on Windows computers. Rtools version 4.0 and more recent can be found [here](https://cran.r-project.org/bin/windows/Rtools/)


## Preparing the data
First, we load the package
```{r library, warning=FALSE, message = FALSE,warning = FALSE}
library(Rsero)
```
We load the data and organize them in the SeroData format, which will be later used for fitting. Required parameters are age_at_sampling, which must be given as positive integers, the seropositivity of each individuals (0, 1, or booleans). Additional parameters are the category to which each individual belongs, a reference.category, the sampling_year.

```{r vietnam, warning=FALSE, message = FALSE,warning = FALSE}
data('chikv_vietnam')
chikv_vietnam$location =  as.character(chikv_vietnam$location)
chik.sero = SeroData(age_at_sampling = chikv_vietnam$age,
                     Y = chikv_vietnam$Y,
                     category = chikv_vietnam$location,
                     reference.category = 'Hue',
                     sampling_year = 2017)
```


## Visualizing the data
We estimate the seroprevalence and plot the seroprevalence by age in each municipality. A large difference between regions and an increase in the seroprevalence with age can be observed.

```{r seroprevalence, warning=FALSE, message = FALSE}
seroprevalence(chik.sero) # Value of the seroprevalence 
```
```{r seroprevalence.plot, warning=FALSE, message = FALSE}
seroprevalence.plot(chik.sero) # plots of the seroprevalence vs age
```

## Model of the force of infection
To define a model of pathogen circulation we use the method *FOImodel()*. Some models have additional parameters, for instance the outbreak models require that we specify the number of peaks *K*. In addition, we can define the prior distributions, and additional parameters such as the seroreversion

```{r list_models, warning=FALSE, message = FALSE}
model = list()
model[[1]] = FOImodel(type='constant')
model[[2]] = FOImodel(type='intervention', K=2)
model[[3]] = FOImodel(type='intervention', K=3)
model[[4]] = FOImodel(type='outbreak', K=1)
model[[5]] = FOImodel(type='outbreak', K=2)
 model[[6]] = FOImodel(type='constantoutbreak')
 model[[7]] = FOImodel(type='independent')
 model[[8]] = FOImodel(type='constant', sp=0.95, se=0.99)
 model[[9]] = FOImodel(type='constant', seroreversion = 1)
```

## Fitting a model to the serological data
Next, we fit each  to the data and compute the DIC and the effective number of parameters pD. For each model, we run 4 independent chains of 10,000 iterations each, where by default the first 5000 are warmups. By specifying the option cores = 4 the chains are run in parallel on 4 CPUs.


The step of evaluating all twelve models being time consuming, we only fit here the model of two successive outbreaks and a background probability of infection.
```{r print_model, warning=FALSE, message = FALSE}
print(model[[8]])
```

```{r fit, warning=FALSE, message = FALSE}
Fit = fit(data = chik.sero,
          model = model[[8]],
          chain=4,
          cores=4, 
          iter=5000)
```


## Specifying additional MCMC parameters
Default parameters for the fit are 5000 iterations (including 2500 warmups), four chains, and a random set of initial parameters. Rstan allows more parameters to be specified by the user. We show a few ones here, but interested users might read the documentation of the rstan::sampling() function [here](https://www.rdocumentation.org/packages/rstan/versions/2.19.2/topics/sampling) 

### Initial parameters
The initial parameters must come as a list of lists with as many elements as the number of chains, and where each list contains (at least some) initial parameters of a given chain. Unless these parameters are specified they are chosen by default at random.

```{r initial.parameters, warning=FALSE, message = FALSE}
 
initial.parameters = list(list(annual_foi=1),list(annual_foi=0.1),list(annual_foi=0.05),list(annual_foi=0.03))
Fit = fit(data = chik.sero,
          model = model[[8]],
          chain=4,
          cores=4,
          iter=10000,
          init = initial.parameters)
```

Additional parameters such as the thinning, the algorithm (HMC, NUTS, Fixed_param), and important parameters to control the sampler behavior (control) can be modified. For example:

A list of the parameters for the HMC algorithm (Hamiltonian Monte-Carlo) can be found [here](https://mc-stan.org/docs/2_19/reference-manual/hmc-algorithm-parameters.html).
 

## Analyzing the results
We included a certain number of functions to analyze the MCMC chains and the posterior distributions of the parameters. First, as presented above, the compute_information_criteria function evaluates the AIC, DIC and WAIC. The AIC, which requires an estimation of the maximum likelihood, is obtained for the ensemble of parameters in the chain that maximizes the likelihood.

```{r compute_information_criteria, warning=FALSE, message = FALSE}
compute_information_criteria(Fit)
```

The package can additionally plot the mean and 95% credible interval of the seroprevalence. It generates as many plots as there are categories.

```{r seroprevalence.fit, warning=FALSE, message = FALSE}
p = seroprevalence.fit(Fit)
```
The plots corresponding to the different categories are stored in a list and accessible using

```{r printFit, warning=FALSE, message = FALSE}
print(Fit$data$unique.categories[1])
```

Similarly, the annual force of infection is obtained by typing
```{r plotFit, warning=FALSE, message = FALSE}
plot(Fit)
```

the *parameters_credible_intervals* function, which gives the mean and 2.5%, 50% and 97.5% quantiles of the posterior distributions of the most relevant parameters.

```{r parameters_credible_intervals, warning=FALSE, message = FALSE}
parameters_credible_intervals(Fit)
```
Visually, it can also be obtained by plotting the posterior distributions
```{r plot_posterior, warning=FALSE, message = FALSE}
plot_posterior(Fit)
```

## Diagnostics

We show here how to do the MCMC chains diagnosis using the tools provided in the *rstan* package. The output object of the fit using the package *Rsero* contains the data, the model, and the fit. These various objects can be extracted using the commands

```{r Fitobjects, warning=FALSE, message = FALSE, eval = FALSE}
Fit$data
Fit$model
Fit$fit
```
Using this fit, it is possible first to obtain the traceplots using the rstan::traceplot function, providing information on chain convergence and mixing. We plot the traceplot for a few parameters only: the probability of background infection, the force of infection of the reference category, the relative force of infection in each category


using
```{r Diagnostics, warning=FALSE, message = FALSE}
stan_diag(Fit$fit, info = 'sample') # shows diagnostic (loglikelihood, acceptance rate)
stan_rhat(Fit$fit) # show the Rhat statistic
stan_ess(Fit$fit) # show the ratio of effective sample size over total sample size
``` 